name: CI/CD Summary

on:
  workflow_run:
    workflows: ["Semantic Release", "yoga-ci/cd"]
    types:
      - completed
    branches:
      - main

jobs:
  send_summary:
    runs-on: ubuntu-latest
    steps:
      - name: Get workflow details
        id: workflow_details
        run: |
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ workflow_run
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_ID="${{ github.event.workflow_run.id }}"
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${WORKFLOW_ID}"
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          
          echo "workflow_name=${WORKFLOW_NAME}" >> $GITHUB_OUTPUT
          echo "workflow_conclusion=${WORKFLOW_CONCLUSION}" >> $GITHUB_OUTPUT
          echo "workflow_url=${WORKFLOW_URL}" >> $GITHUB_OUTPUT
          echo "actor=${ACTOR}" >> $GITHUB_OUTPUT
          echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°
          COMMIT_MSG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${HEAD_SHA}" | \
            jq -r '.commit.message')
          echo "commit_message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğµ, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ±Ñ‹Ğ» semantic-release
          if [[ "${WORKFLOW_NAME}" == "Semantic Release" ]]; then
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ±Ñ‹Ğ» Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ñ€ĞµĞ»Ğ¸Ğ·
            LATEST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest")
            RELEASE_SHA=$(echo $LATEST_RELEASE | jq -r '.target_commitish')
            
            if [[ "${RELEASE_SHA}" == "${HEAD_SHA}" ]]; then
              RELEASE_VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
              RELEASE_URL=$(echo $LATEST_RELEASE | jq -r '.html_url')
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
              echo "release_url=${RELEASE_URL}" >> $GITHUB_OUTPUT
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_release=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Check all workflows for this commit
        id: check_workflows
        run: |
          HEAD_SHA="${{ steps.workflow_details.outputs.head_sha }}"
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ semantic-release workflow
          SEMANTIC_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/semantic-release.yml/runs?head_sha=${HEAD_SHA}")
          
          SEMANTIC_COUNT=$(echo $SEMANTIC_RUNS | jq -r '.total_count')
          if [[ "${SEMANTIC_COUNT}" != "0" ]]; then
            SEMANTIC_STATUS=$(echo $SEMANTIC_RUNS | jq -r '.workflow_runs[0].conclusion')
            SEMANTIC_URL=$(echo $SEMANTIC_RUNS | jq -r '.workflow_runs[0].html_url')
            SEMANTIC_ID=$(echo $SEMANTIC_RUNS | jq -r '.workflow_runs[0].id')
            echo "semantic_release_status=${SEMANTIC_STATUS}" >> $GITHUB_OUTPUT
            echo "semantic_release_url=${SEMANTIC_URL}" >> $GITHUB_OUTPUT
            echo "semantic_release_id=${SEMANTIC_ID}" >> $GITHUB_OUTPUT
          else
            echo "semantic_release_status=not_found" >> $GITHUB_OUTPUT
          fi
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ yoga-ci-cd workflow
          YOGA_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/yoga-ci-cd.yml/runs?head_sha=${HEAD_SHA}")
          
          YOGA_COUNT=$(echo $YOGA_RUNS | jq -r '.total_count')
          if [[ "${YOGA_COUNT}" != "0" ]]; then
            YOGA_STATUS=$(echo $YOGA_RUNS | jq -r '.workflow_runs[0].conclusion')
            YOGA_URL=$(echo $YOGA_RUNS | jq -r '.workflow_runs[0].html_url')
            YOGA_ID=$(echo $YOGA_RUNS | jq -r '.workflow_runs[0].id')
            echo "yoga_ci_cd_status=${YOGA_STATUS}" >> $GITHUB_OUTPUT
            echo "yoga_ci_cd_url=${YOGA_URL}" >> $GITHUB_OUTPUT
            echo "yoga_ci_cd_id=${YOGA_ID}" >> $GITHUB_OUTPUT
          else
            echo "yoga_ci_cd_status=not_found" >> $GITHUB_OUTPUT
          fi

      - name: Check if this is the last workflow to complete
        id: check_last
        run: |
          # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ğ° workflow Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¸ÑÑŒ
          CURRENT_WORKFLOW="${{ github.event.workflow_run.name }}"
          CURRENT_ID="${{ github.event.workflow_run.id }}"
          
          SEMANTIC_STATUS="${{ steps.check_workflows.outputs.semantic_release_status }}"
          YOGA_STATUS="${{ steps.check_workflows.outputs.yoga_ci_cd_status }}"
          
          SEMANTIC_ID="${{ steps.check_workflows.outputs.semantic_release_id }}"
          YOGA_ID="${{ steps.check_workflows.outputs.yoga_ci_cd_id }}"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ñ‹ Ğ»Ğ¸ Ğ¾Ğ±Ğ° workflow Ğ¸ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ workflow Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¼
          if [[ "${SEMANTIC_STATUS}" != "not_found" && "${YOGA_STATUS}" != "not_found" ]]; then
            if [[ "${CURRENT_WORKFLOW}" == "Semantic Release" && "${CURRENT_ID}" == "${SEMANTIC_ID}" && "${YOGA_STATUS}" == "success" ]]; then
              echo "is_last=true" >> $GITHUB_OUTPUT
            elif [[ "${CURRENT_WORKFLOW}" == "yoga-ci/cd" && "${CURRENT_ID}" == "${YOGA_ID}" && "${SEMANTIC_STATUS}" == "success" ]]; then
              echo "is_last=true" >> $GITHUB_OUTPUT
            else
              echo "is_last=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_last=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Summary Notification
        if: steps.check_last.outputs.is_last == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ“‹ CI/CD ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½
            
            ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: ${{ steps.workflow_details.outputs.actor }}
            ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ steps.workflow_details.outputs.commit_message }}
            
            ğŸ“Š Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹:
            - ğŸš€ Semantic Release: ${{ steps.check_workflows.outputs.semantic_release_status }}
            - ğŸ”„ CI/CD: ${{ steps.check_workflows.outputs.yoga_ci_cd_status }}
            
            ${{ steps.check_workflows.outputs.is_release == 'true' && 'âœ… **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·:** ' || 'âŒ Ğ ĞµĞ»Ğ¸Ğ· Ğ½Ğµ Ğ±Ñ‹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½' }} ${{ steps.check_workflows.outputs.release_version || '' }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ¸:
            ${{ steps.check_workflows.outputs.is_release == 'true' && format('- [Ğ ĞµĞ»Ğ¸Ğ·]({0})', steps.check_workflows.outputs.release_url) || '' }}
            - [Semantic Release](${{ steps.check_workflows.outputs.semantic_release_url }})
            - [CI/CD](${{ steps.check_workflows.outputs.yoga_ci_cd_url }}) 